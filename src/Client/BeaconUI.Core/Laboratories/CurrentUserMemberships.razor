@using Beacon.Common.Laboratories
@using Beacon.Common.Laboratories.Requests
@using BeaconUI.Core.Laboratories.Services

@inject CurrentUserMembershipProvider MembershipProvider

@implements IDisposable

@ChildContent?.Invoke(this)

@code {

    [Parameter] public RenderFragment<CurrentUserMemberships>? ChildContent { get; set; }

    private List<LaboratoryMembershipDto>? Memberships { get; set; }

    protected override async Task OnInitializedAsync()
    {
        MembershipProvider.MembershipsChanged += HandleMembershipsChanged;
        Memberships = await MembershipProvider.GetMembershipsAsync();
    }

    public void Dispose()
    {
        MembershipProvider.MembershipsChanged -= HandleMembershipsChanged;
    }

    public IReadOnlyList<LaboratoryMembershipDto>? GetAll()
    {
        return Memberships?.AsReadOnly();
    }

    public LaboratoryMembershipDto? GetMembership(Guid labId)
    {
        return Memberships?.FirstOrDefault(m => m.LaboratoryId == labId);
    }

    private void HandleMembershipsChanged(List<LaboratoryMembershipDto> memberships)
    {
        Memberships = memberships;
        StateHasChanged();
    }
}