<CascadingValue Value="this">
    @ChildContent?.Invoke(this)
</CascadingValue>

@code {

    [Inject]
    private ICurrentUser CurrentUser { get; set; } = null!;

    [CascadingParameter]
    public required LaboratoryDto CurrentLab { get; set; }

    [CascadingParameter]
    public required IModalService ModalService { get; set; }

    [Parameter]
    public RenderFragment<MembershipContext>? ChildContent { get; set; }

    public ErrorOr<LaboratoryMemberDto[]>? Result { get; private set; }

    protected override async Task OnParametersSetAsync()
    {
        Result = await ApiClient.GetLaboratoryMembers();
    }

    public bool CanManagePermissions()
    {
        return CurrentLab.MyMembershipType >= LaboratoryMembershipType.Manager;
    }

    public bool CanManagePermissions(LaboratoryMemberDto memberToUpdate)
    {
        return CanManagePermissions()
            && memberToUpdate.Id != CurrentUser.UserId
            && CurrentLab.MyMembershipType >= memberToUpdate.MembershipType;
    }

    public async Task ShowManagePermissionsModal(LaboratoryMemberDto memberToUpdate)
    {
        var modalParameters = new ModalParameters()
            .Add(nameof(UpdateMembershipTypeModal.CurrentLab), CurrentLab)
            .Add(nameof(UpdateMembershipTypeModal.MemberToUpdate), memberToUpdate);

        var result = await ModalService.Show<UpdateMembershipTypeModal>("Update Membership", modalParameters).Result;

        if (result.Confirmed)
            Result = await ApiClient.GetLaboratoryMembers();

        StateHasChanged();
    }
}