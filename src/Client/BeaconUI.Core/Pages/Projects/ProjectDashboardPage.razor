@page "/l/projects"
@attribute [Authorize]
@layout LaboratoryLayout

<div class="d-flex flex-column flex-grow-1" style="overflow-x: auto;">
    <LaboratoryPageHeader>
        <ButtonsContent>
            <button type="button" class="btn btn-primary" @onclick="ShowCreateProjectsModal">
                <span class="icon">
                    <i class="fa-solid fa-plus"></i>
                </span>
                <span>Create project</span>
            </button>
        </ButtonsContent>
    </LaboratoryPageHeader>

    <div class="content flex-grow-1" style="background-color: #f8fafc">
        <div class="px-4 h-100">
            @if (ProjectsOrError is not { } projectsOrError)
            {
                <p>Loading...</p>
            }
            else if (projectsOrError.IsError)
            {
                <p class="text-danger">There was an error loading lab projects. Please try again later.</p>
            }
            else if (projectsOrError.Value.Length == 0)
            {
                <p>No projects found!</p>
            }
            else
            {
                <table class="table">
                    <thead>
                        <tr>
                            <th>Project Code</th>
                            <th>Project Status</th>
                            <th>Customer Name</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (projectsOrError.Value.Length == 0)
                        {
                            <tr>
                                <td colspan="100">No projects found!</td>
                            </tr>
                        }
                        else
                        {
                            foreach (var project in projectsOrError.Value)
                            {
                                <tr>
                                    <td>
                                        @project.ProjectCode
                                    </td>
                                    <td>
                                        @project.ProjectStatus
                                    </td>
                                    <td>
                                        @project.CustomerName
                                    </td>
                                    <td>
                                        <a href="l/projects/@project.ProjectCode">View Details</a>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>
</div>

@code {

    [CascadingParameter] public required IModalService ModalService { get; set; }

    private ErrorOr<ProjectDto[]>? ProjectsOrError { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadProjects();
    }

    private async Task ShowCreateProjectsModal()
    {
        var result = await ModalService.Show<CreateProjectForm>("Create New Project").Result;

        if (!result.Cancelled)
        {
            ProjectsOrError = null;
            await LoadProjects();
        }
    }

    private async Task LoadProjects()
    {
        ProjectsOrError = await ApiClient.GetProjects();
    }
}